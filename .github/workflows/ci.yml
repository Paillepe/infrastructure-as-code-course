name: CI

on:
  push:
    branches: [ main, dev, recette ]
    # Ici c'est pour inclure les push avec les tags de version : vx.x.x
    # * pour toutes les valeurs
    tags:
      - "v*"
  pull_request:

permissions:
  contents: read

  # Variables globales (utilisent les secrets GitHub)
env:
  REGISTRY: ${{ secrets.ACR_LOGIN_SERVER }}
  #Ancien version pour le versionning
  #VERSION: ${{ github.ref_name }}

jobs:
# ======================================================
# ðŸ”¢ VERSIONING (AVANT TOUT)
# ======================================================
  versioning:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    # ðŸ”‘ Ã‰criture autorisÃ©e UNIQUEMENT ici
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Git config
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"

      - name: Compute bump intent
        id: bump
        run: |
          MSG="$(git log -1 --pretty=%B)"
          if echo "$MSG" | grep -q "\[major\]"; then
            echo "kind=major" >> $GITHUB_OUTPUT
          elif echo "$MSG" | grep -q "\[minor\]"; then
            echo "kind=minor" >> $GITHUB_OUTPUT
          elif echo "$MSG" | grep -q "\[patch\]"; then
            echo "kind=patch" >> $GITHUB_OUTPUT
          else
            echo "kind=none" >> $GITHUB_OUTPUT
          fi

      - name: Version frontend & backend
        run: |
          set -e
          BRANCH="${{ github.ref_name }}"
          KIND="${{ steps.bump.outputs.kind }}"

          version_pkg () {
            DIR=$1
            PREID=$2
            cd "$DIR"

            if [ "$BRANCH" = "main" ]; then
              BASE="$(node -p "require('./package.json').version.split('-')[0]")"
              npm version "$BASE"
            else
              if [ "$KIND" = "patch" ]; then npm version prepatch --preid=$PREID
              elif [ "$KIND" = "minor" ]; then npm version preminor --preid=$PREID
              elif [ "$KIND" = "major" ]; then npm version premajor --preid=$PREID
              else npm version prerelease --preid=$PREID
              fi
            fi
            cd -
          }

          if [ "$BRANCH" = "dev" ]; then
            version_pkg apps/frontend dev
            version_pkg apps/backend dev
          elif [ "$BRANCH" = "recette" ]; then
            version_pkg apps/frontend rc
            version_pkg apps/backend rc
          elif [ "$BRANCH" = "main" ]; then
            version_pkg apps/frontend rc
            version_pkg apps/backend rc
          fi

      - name: Push versions & tags
        run: |
          git push origin HEAD:${{ github.ref_name }}
          git push origin --tags

  # ======= BACK-END =======
  Back_CI:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/backend/package-lock.json

      - name: Install dependencies back
        working-directory: apps/backend
        run: npm ci
      # run: npm ci dÃ©pendances packages-lock.json, pas comme npm install sur packages.json

      # ðŸ§ª Tests
      - name: Run tests back  
        working-directory: apps/backend
        run: npm test

      # ðŸ§¹ Lint (eslint)
      - name: Run linter back
        working-directory: apps/backend
        run: npm run lint

      # ðŸ”’ Vulnerability scan
      - name: Security audit back (critical only)
        working-directory: apps/backend
        run: npm audit --audit-level=critical
        continue-on-error: true

  # ======= FRONT-END=======
  front_ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: apps/frontend/package-lock.json

      - name: Install dependencies front 
        working-directory: apps/frontend
        run: npm ci
      # run: npm ci dÃ©pendances packages-lock.json, pas comme npm install sur packages.json

      # ðŸ§ª Tests
      - name: Run tests front  
        working-directory: apps/frontend
        run: npm test

      # ðŸ§¹ Lint (eslint)
      - name: Run linter front
        working-directory: apps/frontend
        run: npm run lint

      # ðŸ”’ Vulnerability scan
      - name: Security audit front (critical only)
        working-directory: apps/frontend
        run: npm audit --audit-level=critical
        continue-on-error: true

  # ========= BANK-END DOCKER AZURE =========
  back_docker:
    runs-on: ubuntu-latest
    needs: Back_CI

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        run: |
           echo "${{ secrets.ACR_PASSWORD }}" | docker login $REGISTRY \
            -u "${{ secrets.ACR_USERNAME }}" --password-stdin

      - name: Build backend Docker image
        run: |
           docker build \
            -t $REGISTRY/backend-node:latest \
            -t $REGISTRY/backend-node:${VERSION} \
             apps/backend

      - name: Push backend Docker image
        run: |
           docker push $REGISTRY/backend-node:latest
           docker push $REGISTRY/backend-node:${VERSION}

  # ======= FRONT-END DOCKER =======
  front_docker:
    runs-on: ubuntu-latest
    needs: front_ci

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure Container Registry
        run: |
          echo "${{ secrets.ACR_PASSWORD }}" | docker login $REGISTRY \
            -u "${{ secrets.ACR_USERNAME }}" --password-stdin

      - name: Build frontend Docker image
        run: |
          docker build \
           -t $REGISTRY/frontend-node:latest \
           -t $REGISTRY/frontend-node:${VERSION} \
            apps/frontend

      - name: Push frontend Docker image
        run: |
          docker push $REGISTRY/frontend-node:${VERSION}
          docker push $REGISTRY/frontend-node:latest

